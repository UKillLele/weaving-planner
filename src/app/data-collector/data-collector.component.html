<ngb-accordion activeIds="patternInfo" #acc="ngbAccordion" animation="true">
    <ngb-panel id="patternInfo">
        <ng-template ngbPanelHeader let-opened="opened">
            <div class="d-flex align-items-center justify-content-between">
              <h1 class="h2 m-0">Pattern Information</h1>
              <div>
                <button class="btn btn-outline-primary me-3" *ngIf="previewAvailable" (click)="open(preview)">Preview</button>
                <button type="button" class="btn btn-secondary me-3" *ngIf="pattern.id" (click)="clearForm()">Clear</button>
                <div *ngIf="savedPatterns.length > 0" ngbDropdown class="d-inline-block me-3">
                    <button class="btn btn-outline-primary" id="loadDropdown" ngbDropdownToggle><span class="me-2">Load</span></button>
                    <div ngbDropdownMenu aria-labelledby="loadDropdown">
                        <button 
                            *ngFor="let pat of savedPatterns" 
                            (click)="getPattern(pat.id!)" 
                            ngbDropdownItem
                            [ngClass]="['dropdown-item', pat.id === pattern.id ? 'active' : '']"
                        >
                            {{pat.name}}
                        </button>
                    </div>
                  </div>
                <button *ngIf="user?.userDetails" class="btn btn-primary me-4" type="button" (click)="savePattern()">Save</button>
                <button ngbPanelToggle class="btn btn-link p-0" type="button" aria-label="toggle instructions"><i [ngClass]="['fa', opened ? 'fa-angle-up' : 'fa-angle-down', 'fa-2x']" aria-hidden="true"></i></button>
                </div>
            </div>
        </ng-template>
        <ng-template ngbPanelContent>
            <form [formGroup]="patternForm" (ngSubmit)="onPatternSubmit()" class="container-fluid">
                <div class="row row-col-auto">
                    <div class="col col-auto mb-3">
                        <div class="form-floating">
                            <input class="form-control" type="text" placeholder="pattern name" formControlName="name" id="name">
                            <label for="name">pattern name</label>
                        </div>
                    </div>
                    <div class="col col-auto mb-3">
                        <div class="form-floating">
                            <input class="form-control" type="number" placeholder="shafts" id="shafts" formControlName="shafts">
                            <label for="shafts">shafts</label>
                        </div>
                    </div>
                    <div class="col col-auto mb-3">
                        <div class="form-floating">
                            <input class="form-control" type="number" placeholder="treadles" id="treadles" formControlName="treadles">
                            <label for="treadles">treadles</label>
                        </div>
                    </div>
                    <div class="col col-auto mb-3">
                        <div class="form-floating">
                            <input class="form-control" type="number" placeholder="dpi" id="dpi" formControlName="dpi">
                            <label for="dpi">dents per inch</label>
                        </div>
                    </div>
                    <div class="col col-auto my-auto">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" formControlName="trompAsWrit" (change)="trompChanged()" id="trompAsWrit">
                            <label class="form-check-label" for="trompAsWrit">
                                tromp as writ
                            </label>
                        </div>
                    </div>
                    <div class="col col-auto my-auto">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" formControlName="halfSett" (change)="settChanged()" id="halfSett">
                            <label class="form-check-label" for="halfSett">
                                half sett
                            </label>
                        </div>
                    </div>
                    <div class="col col-auto my-auto me-auto">
                        <button class="btn btn-outline-primary mb-3" type="button" (click)="open(srtDialog)">SRT</button>
                    </div>
                </div>
                <section>
                    <h2 class="h3">Warp</h2>
                    <div class="row row-col-auto">
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" placeholder="finished width" id="finishedWidth" formControlName="finishedWidth">
                                    <label for="finishedWidth">finished width</label>
                                </div>
                                <span class="input-group-text">inches</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input type="number" class="form-control" (change)="patternWidthChanged()" placeholder="patternWidth" id="patternWidth" formControlName="patternWidth">
                                    <label for="patternWidth">pattern width</label>
                                </div>
                                <span class="input-group-text">ends</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="form-floating">
                                <input type="number" class="form-control" placeholder="epi" id="epi" formControlName="epi" (change)="epiChanged()">
                                <label for="epi">ends per inch</label>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" id="waste" placeholder="loom waste" type="number" formControlName="waste">
                                    <label for="waste">loom waste</label>
                                </div>
                                <span class="input-group-text">inches</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating w-auto">
                                    <select class="form-select" style="width: 8.5rem" id="topEdgeType" formControlName="topEdgeType" (change)="edgeTypeChanged()">
                                        <option value="fringe">fringe</option>
                                        <option value="hem">hem</option>
                                    </select>
                                    <label for="topEdgeType">top edge type</label>
                                </div>
                                <div class="form-floating">
                                    <input class="form-control" id="topEdgeLength" placeholder="top edge length" type="number" formControlName="topEdgeLength" (change)="edgeChanged('warp')">
                                    <label for="topEdgeLength">top edge length</label>
                                </div>
                                <span class="input-group-text">ends</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating w-auto">
                                    <select class="form-select" style="width: 10rem" id="bottomEdgeType" formControlName="bottomEdgeType" (change)="edgeTypeChanged()">
                                        <option value="fringe">fringe</option>
                                        <option value="hem">hem</option>
                                    </select>
                                    <label for="bottomEdgeType">bottom edge type</label>
                                </div>
                                <div class="form-floating">
                                    <input class="form-control" id="bottomEdgeLength" placeholder="bottom edge length" type="number" formControlName="bottomEdgeLength" (change)="edgeChanged('warp')">
                                    <label for="bottomEdgeLength">bottom edge length</label>
                                </div>
                                <span class="input-group-text">ends</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="pieces" placeholder="pieces" formControlName="pieces">
                                    <label for="pieces"># of pieces</label>
                                </div>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="form-floating">
                                <select class="form-select" id="warpMaterial" formControlName="warpMaterial" (change)="yarnChanged('warp')">
                                    <option *ngFor="let yarn of YarnTypes" [value]="yarn.name">{{yarn.name}}</option>
                                </select>
                                <label for="warpMaterial">yarn type</label>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="warpTakeUp" placeholder="take up" formControlName="warpTakeUp">
                                    <label for="warpTakeUp">take up</label>
                                </div>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="warpShrinkage" placeholder="shrinkage" formControlName="warpShrinkage">
                                    <label for="warpShrinkage">shrinkage</label>
                                </div>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="sampleLength" placeholder="sample length" formControlName="sampleLength">
                                    <label for="sampleLength">sample length</label>
                                </div>
                                <span class="input-group-text">inches</span>
                            </div>
                        </div>
                    </div>
                </section>
                <section>
                    <h2 class="h3">Weft</h2>
                    <div class="row row-col-auto">
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="finished-length" placeholder="finished length" formControlName="finishedLength">
                                    <label for="finishedLength">finished length</label>
                                </div>
                                <span class="input-group-text">inches</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="patternLength" placeholder="pattern length" formControlName="patternLength">
                                    <label for="patternLength">pattern length</label>
                                </div>
                                <span class="input-group-text">picks</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="form-floating">
                                <input class="form-control" type="number" id="ppi" placeholder="picks per inch" formControlName="ppi">
                                <label for="ppi">picks per inch</label>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" id="selvageWidth" placeholder="selvage" type="number" formControlName="selvageWidth"/>
                                    <label for="selvageWidth">selvage</label>
                                </div>
                                <span class="input-group-text">picks</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="weft-left-fringe" placeholder="left fringe" formControlName="weftLeftFringe" (change)="edgeChanged('weft')">
                                    <label for="weftLeftFringe">left fringe</label>
                                </div>
                                <span class="input-group-text">picks</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="weft-right-fringe" placeholder="right fringe" formControlName="weftRightFringe" (change)="edgeChanged('weft')">
                                    <label for="weftRightFringe">right fringe</label>
                                </div>
                                <span class="input-group-text">picks</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="form-floating">
                                <select class="form-select" id="weftMaterial" formControlName="weftMaterial" (change)="yarnChanged('weft')">
                                    <option *ngFor="let yarn of YarnTypes" [value]="yarn.name">{{yarn.name}}</option>
                                </select>
                                <label for="weftMaterial">yarn type</label>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="weftTakeUp" placeholder="take up" formControlName="weftTakeUp">
                                    <label for="weftTakeUp">take up</label>
                                </div>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col col-auto mb-3">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input class="form-control" type="number" id="weftShrinkage" placeholder="shrinkage" formControlName="weftShrinkage">
                                    <label for="weftShrinkage">shrinkage</label>
                                </div>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                </section>
                <section align="end">
                    <button class="btn btn-primary">Update</button>
                </section>
            </form>
        </ng-template>
    </ngb-panel>

    <ngb-panel id="yarnBreakdown">
        <ng-template ngbPanelHeader let-opened="opened">
            <div class="d-flex align-items-center justify-content-between">
              <h1 class="h2 m-0">Yarn Breakdown</h1>
              <button ngbPanelToggle class="btn btn-link p-0" type="button" aria-label="toggle instructions"><i [ngClass]="['fa', opened ? 'fa-angle-up' : 'fa-angle-down', 'fa-2x']" aria-hidden="true"></i></button>
            </div>
        </ng-template>
        <ng-template ngbPanelContent>
            <section class="row row-col-auto">
                <div class="col col-auto">
                    sley order: | 
                    <span *ngFor="let count of pattern.sleyOrder"> {{count}} | </span> 
                    {{pattern.sleyEpi}}
                </div>
            </section>
            <section class="row row-col-auto">
                <div class="col col-auto">total yardage: {{pattern.totalIn / 36 | ceil }} yds</div>
                <div class="col col-auto">total warp yardage: {{pattern.warpIn / 36 | ceil }} yds</div>
                <div class="col col-auto">total weft yardage: {{pattern.weftIn / 36 | ceil }} yds</div>
            </section>
            <section class="row row-col-auto">
                <div class="col col-auto" *ngFor="let color of pattern.colors">
                    <div class="align-middle">
                        <span style="width: 15px; height: 15px; display: inline-block; border: 1px solid black" [style.backgroundColor]="color.colorCode"></span>
                        : {{color.colorInches / 36 | ceil }} yds
                    </div>
                </div>
            </section>
            <section class="row row-col-auto">
                <div class="col col-auto">width in reed:</div>
                <div class="col col-auto">length on loom:</div>
            </section>
            <section class="row row-col-auto">
                <div class="col col-auto">width pattern repeats:</div>
                <div class="col col-auto">length pattern repeats (per piece):</div>
                <!-- project preview -->
            </section>
        </ng-template>
    </ngb-panel>
</ngb-accordion>

<ng-template #srtDialog let-modal>
    <div class="modal-header">
        <h1 class="h3" ngbAutofocus>Scottish Registry of Tartans</h1>
        <button type="button" class="close btn btn-link" aria-label="Close" (click)="modal.dismiss('Cross click')">
          <i class="fa fa-times fa-2x" aria-hidden="true"></i>
        </button>
    </div>
    <form class="modal-body" [formGroup]="srtForm">
        <div class="mb-3">
            <label for="srtThreadcount">Threadcount</label>
            <input class="form-control" type="text" placeholder="e.g. G20R4B40W4R4W4A40W4A40W4Y4" id="srtThreadcount" formControlName="srtThreadcount" />
        </div>
        <div>
            <label for="srtPalette">Palette</label>
            <textarea class="form-control" rows="3" placeholder="e.g. W=E0E0E0WHITE;A=5C8CA8AZURE;R=C80000RED;B=2C2C80BLUE;G=006818GREEN;Y=E8C000YELLOW" id="srtPalette" formControlName="srtPalette"></textarea>
        </div>
    </form>
    <div class="modal-footer">
        <button class="btn btn-secondary">Cancel</button>
        <button (click)="onSrtSubmit()" class="btn btn-primary">OK</button>
    </div>
</ng-template>

<ng-template #preview let-modal>
    <div class="modal-header">
      <h1 class="modal-title h3">Preview</h1>
      <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      <div>
        <p>TODO</p>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline-dark" (click)="modal.close('Save click')">Close</button>
    </div>
</ng-template>